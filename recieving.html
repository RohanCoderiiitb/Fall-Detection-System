<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: "Inter", sans-serif; }
    .log-box { height: 200px; }
    #enableNotifications {
      position: fixed; top: 20px; right: 20px;
      background-color: #f59e0b; color: black; font-weight: bold;
      padding: 10px 20px; border-radius: 8px; cursor: pointer; z-index: 100;
    }
    #enableNotifications.hidden { display: none; }
    #fallAlertPopup {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: #dc2626; color: white; font-weight: bold;
      padding: 25px 40px; border-radius: 12px; font-size: 1.5rem;
      z-index: 1000; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
      animation: pulse 1s infinite alternate;
      display: none;
    }
    @keyframes pulse {
      from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      to { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); }
    }
  </style>
</head>
<body class="bg-gray-800 text-white min-h-screen p-4 md:p-8">

  <div id="fallAlertPopup">ðŸš¨ FALL DETECTED! ðŸš¨</div>
  <button id="enableNotifications">Enable Fall Alerts</button>

  <div class="max-w-5xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-green-400">Patient Monitor Dashboard</h1>
      <p class="text-lg text-gray-400">Real-time data from Firebase</p>
    </header>

    <div class="grid md:grid-cols-3 gap-8">
      <!-- HEALTH -->
      <div class="bg-gray-900 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-blue-400">Current Vitals</h2>
        <div class="grid grid-cols-2 gap-4 text-center">
          <div>
            <p class="text-xl text-gray-400">Avg. Heart Rate</p>
            <p id="bpmLabel" class="text-5xl font-bold text-red-400">--</p>
          </div>
          <div>
            <p class="text-xl text-gray-400">Patient Status</p>
            <p id="statusLabel" class="text-4xl font-bold text-yellow-400">--</p>
          </div>
          <div>
            <p class="text-xl text-gray-400">Heartbeat</p>
            <p id="heartbeatLabel" class="text-3xl font-bold text-gray-300">--</p>
          </div>
          <div>
            <p class="text-xl text-gray-400">Fall Risk</p>
            <p id="fallRiskLabel" class="text-3xl font-bold text-red-500">--</p>
          </div>
        </div>
        <p id="vitalsTimeLabel" class="text-sm text-gray-400 text-center mt-4">Last updated: --</p>
      </div>

      <!-- LOCATION -->
      <div class="bg-gray-900 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-purple-400">Last Known Location</h2>
        <div class="text-center">
          <p class="text-xl text-gray-400">Latitude</p>
          <p id="latLabel" class="text-4xl font-mono text-green-300 mb-4">--</p>
          <p class="text-xl text-gray-400">Longitude</p>
          <p id="lonLabel" class="text-4xl font-mono text-green-300 mb-4">--</p>
          <p id="locationTimeLabel" class="text-sm text-gray-500">No updates yet</p>
          <a id="mapsLink" href="#" target="_blank"
            class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white opacity-50 pointer-events-none">
            Open in Maps
          </a>
        </div>
      </div>

      <!-- FALL ALERT -->
      <div class="bg-red-900 border-4 border-red-500 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 text-yellow-300">ðŸš¨ Last Fall Alert ðŸš¨</h2>
        <p id="fallTimeLabel" class="text-2xl text-center text-white">No falls detected.</p>
        <a id="fallMapsLink" href="#" target="_blank"
          class="mt-4 hidden bg-yellow-400 hover:bg-yellow-500 px-4 py-2 rounded text-black font-bold text-center w-full">View
          Fall Location</a>
      </div>
    </div>

    <div class="bg-gray-900 p-6 rounded-lg shadow-lg mt-8">
      <h2 class="text-2xl font-semibold mb-4 text-blue-400">Live Health Log</h2>
      <div id="healthLog"
        class="w-full p-4 rounded-md bg-gray-900 text-gray-400 font-mono h-64 overflow-y-scroll text-sm border border-gray-700">
        Listening for health data...
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAyK2-KWdKmufeMiD5AxRtY8DzT0UlTCuI",
      authDomain: "esp32healthmonitor-4a227.firebaseapp.com",
      databaseURL: "https://esp32healthmonitor-4a227-default-rtdb.firebaseio.com",
      projectId: "esp32healthmonitor-4a227",
      storageBucket: "esp32healthmonitor-4a227.firebasestorage.app",
      messagingSenderId: "732442839615",
      appId: "1:732442839615:web:e118ae43311ec41595c68a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const messaging = firebase.messaging();

    const bpmLabel = document.getElementById('bpmLabel');
    const statusLabel = document.getElementById('statusLabel');
    const heartbeatLabel = document.getElementById('heartbeatLabel');
    const fallRiskLabel = document.getElementById('fallRiskLabel');
    const vitalsTimeLabel = document.getElementById('vitalsTimeLabel');
    const latLabel = document.getElementById('latLabel');
    const lonLabel = document.getElementById('lonLabel');
    const locationTimeLabel = document.getElementById('locationTimeLabel');
    const mapsLink = document.getElementById('mapsLink');
    const fallTimeLabel = document.getElementById('fallTimeLabel');
    const fallMapsLink = document.getElementById('fallMapsLink');
    const healthLog = document.getElementById('healthLog');
    const enableNotificationsButton = document.getElementById('enableNotifications');
    const fallAlertPopup = document.getElementById('fallAlertPopup');

    // Helper to format time
    function formatTime(isoString) {
      try {
        return new Date(isoString).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
      } catch {
        return 'Invalid Time';
      }
    }

    // Notifications Permission
    enableNotificationsButton.addEventListener('click', () => {
      Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          enableNotificationsButton.classList.add('hidden');
          messaging.getToken({
            vapidKey: "BLMNhGabmgvQPWS8sAzxvFPpyIsyFaY7wcMBd3EmSXfZwwNblFSXIJT8kFYi8Fd1vujGPFeO6u6rmjs247jUe9Y"
          }).then((token) => {
            if (token) {
              db.ref('/caretaker_token').set(token);
              alert('Alerts enabled for this device!');
            }
          });
        }
      });
    });

    // In-page notification
    messaging.onMessage((payload) => {
      console.log('Message received:', payload);
      triggerFallAlert(payload.notification.body || "Fall detected!");
    });

    // Listen for Health Data
    db.ref('/health').limitToLast(20).on('child_added', (snap) => {
      const data = snap.val();
      bpmLabel.textContent = data.avg_bpm || '--';
      statusLabel.textContent = data.status || '--';
      heartbeatLabel.textContent = data.heartbeat || '--';
      fallRiskLabel.textContent = data.fall_risk || '--';
      vitalsTimeLabel.textContent = `Last updated: ${formatTime(data.timestamp)}`;

      if (data.fall_risk === "Yes") {
        fallRiskLabel.classList.add('text-red-500');
        fallRiskLabel.classList.remove('text-green-500');
      } else {
        fallRiskLabel.classList.add('text-green-500');
        fallRiskLabel.classList.remove('text-red-500');
      }

      const logMsg = `[${formatTime(data.timestamp)}] BPM: ${data.avg_bpm}, Status: ${data.status}, Risk: ${data.fall_risk}`;
      healthLog.innerHTML = logMsg + '\n' + healthLog.innerHTML;
    });

    // Listen for Location Data
    db.ref('/location').limitToLast(1).on('value', (snap) => {
      if (!snap.exists()) return;
      const data = Object.values(snap.val())[0];
      latLabel.textContent = data.lat.toFixed(6);
      lonLabel.textContent = data.lon.toFixed(6);
      locationTimeLabel.textContent = `At: ${formatTime(data.timestamp)}`;
      mapsLink.href = `https://www.google.com/maps?q=${data.lat},${data.lon}`;
      mapsLink.classList.remove('opacity-50', 'pointer-events-none');
    });

    // Listen for Fall Alerts
    db.ref('/fall_alerts').limitToLast(1).on('value', (snap) => {
      if (!snap.exists()) return;
      const data = Object.values(snap.val())[0];
      fallTimeLabel.textContent = `Fall detected at ${formatTime(data.timestamp)}`;
      fallTimeLabel.classList.add('font-bold');
      fallMapsLink.href = `https://www.google.com/maps?q=${data.lat},${data.lon}`;
      fallMapsLink.style.display = 'block';
      triggerFallAlert("Fall detected at " + formatTime(data.timestamp));
    });

    // --- Visual + Audio Fall Alert ---
    function triggerFallAlert(message) {
      fallAlertPopup.textContent = `ðŸš¨ ${message} ðŸš¨`;
      fallAlertPopup.style.display = 'block';
      const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
      audio.play();
      setTimeout(() => { fallAlertPopup.style.display = 'none'; }, 5000);
    }
  </script>
</body>
</html>
